<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Snake Ultimate</title>
    <style>
        /* --- RESET & LAYOUT --- */
        body {
            background-color: #879c85; /* Nokia Green */
            margin: 0;
            overflow: hidden;
            touch-action: none; /* Disabilita scroll nativo */
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- TOP BAR (Header) --- */
        #top-bar {
            height: 50px;
            background-color: #000;
            color: #879c85;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 100;
            flex-shrink: 0; /* Non si schiaccia */
        }
        #score-box {
            font-size: 18px;
            font-weight: bold;
        }
        #pause-btn {
            background: #879c85;
            color: #000;
            border: none;
            padding: 5px 15px;
            font-weight: bold;
            font-family: inherit;
            border-radius: 4px;
            font-size: 14px;
        }

        /* --- GAME AREA --- */
        #game-container {
            flex-grow: 1; /* Occupa tutto lo spazio rimanente */
            position: relative;
            background-color: #879c85;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* --- MENUS & OVERLAYS --- */
        .overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            color: #879c85;
        }
        .hidden { display: none !important; }
        
        h1 { margin: 0 0 30px 0; font-size: 32px; letter-spacing: 2px; text-transform: uppercase; }
        
        .menu-btn {
            width: 200px;
            padding: 15px;
            margin: 10px 0;
            background: transparent;
            border: 2px solid #879c85;
            color: #879c85;
            font-family: inherit;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }
        .menu-btn:active { background: #879c85; color: #000; }

        /* --- LEADERBOARD STYLE --- */
        #lb-container { width: 80%; max-width: 300px; text-align: left; }
        .lb-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 5px 0; margin-bottom: 5px; font-size: 14px;}
        .lb-top { color: #ffff00; font-weight: bold; text-shadow: 0 0 5px orange; } /* Easter egg style */

        /* --- ABOUT STYLE --- */
        #about-content { text-align: center; line-height: 1.6; font-size: 16px; }
        .heart-link { 
            color: #ff3333; 
            font-size: 40px; 
            text-decoration: none; 
            display: inline-block;
            margin-top: 10px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="top-bar">
        <div id="score-box">SCORE: <span id="score-val">0</span></div>
        <button id="pause-btn" ontouchstart="openMenu()">PAUSE</button>
    </div>

    <div id="game-container">
        <canvas id="gc"></canvas>
    </div>

    <div id="main-menu" class="overlay hidden">
        <h1>PAUSED</h1>
        <button class="menu-btn" id="btn-resume" onclick="resumeGame()">RESUME</button>
        <button class="menu-btn" onclick="newGame()">NEW GAME</button>
        <button class="menu-btn" onclick="showLeaderboard()">BEST SCORE</button>
        <button class="menu-btn" onclick="showAbout()">ABOUT</button>
    </div>

    <div id="lb-menu" class="overlay hidden">
        <h1>TOP 5</h1>
        <div id="lb-container"></div>
        <button class="menu-btn" style="margin-top:30px" onclick="backToMain()">BACK</button>
    </div>

    <div id="about-menu" class="overlay hidden">
        <h1>ABOUT</h1>
        <div id="about-content">
            I LOVE<br>
            NOKIA 3310<br><br>
            <a href="https://github.com/Dad-89" class="heart-link">&hearts;</a>
        </div>
        <button class="menu-btn" style="margin-top:30px" onclick="backToMain()">BACK</button>
    </div>

<script>
    // --- CORE VARIABLES ---
    const canvas = document.getElementById("gc");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score-val");
    
    // Menus
    const mainMenu = document.getElementById("main-menu");
    const lbMenu = document.getElementById("lb-menu");
    const aboutMenu = document.getElementById("about-menu");
    const btnResume = document.getElementById("btn-resume");

    let gridSize = 20;
    let tileCountX, tileCountY;
    
    // Snake State
    let px, py;
    let xv=0, yv=0;
    let trail = [];
    let tail = 5;
    let score = 0;
    let ax, ay; // Apple
    
    let isPaused = false;
    let gameInterval;
    
    // TOUCH LOGIC VARIABLES
    let touchStartX = null;
    let touchStartY = null;

    // --- INITIALIZATION ---
    window.onload = () => {
        resize();
        window.addEventListener('resize', resize);
        
        // Input Listeners (Keyboard + Touch)
        document.addEventListener('keydown', handleKey);
        
        // *** THE MAGIC MOVEMENT LISTENER ***
        // Usiamo touchmove per reattività istantanea
        const gameArea = document.getElementById("game-container");
        gameArea.addEventListener('touchstart', handleTouchStart, {passive: false});
        gameArea.addEventListener('touchmove', handleTouchMove, {passive: false});
        
        // Init Leaderboard if empty
        initLeaderboard();
        
        // Start Game
        newGame();
    };

    function resize() {
        // Calcola la grandezza del canvas basandosi sul container (che è sotto la barra nera)
        const container = document.getElementById("game-container");
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        tileCountX = Math.floor(canvas.width / gridSize);
        tileCountY = Math.floor(canvas.height / gridSize);
    }

    // --- GAME LOGIC ---
    function newGame() {
        score = 0;
        tail = 5;
        trail = [];
        xv = 1; yv = 0; // Parte andando a destra
        scoreEl.innerText = 0;
        
        px = Math.floor(tileCountX / 2);
        py = Math.floor(tileCountY / 2);
        
        closeAllMenus();
        spawnApple();
        
        if(gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(gameLoop, 1000/12); // 12 FPS
        isPaused = false;
    }

    function resumeGame() {
        closeAllMenus();
        isPaused = false;
    }

    function gameLoop() {
        if(isPaused) return;

        px += xv;
        py += yv;

        // WRAP (Passa muri)
        if(px < 0) px = tileCountX - 1;
        if(px > tileCountX - 1) px = 0;
        if(py < 0) py = tileCountY - 1;
        if(py > tileCountY - 1) py = 0;

        // Background
        ctx.fillStyle = "#879c85";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Snake
        ctx.fillStyle = "#000";
        for(let i=0; i<trail.length; i++) {
            ctx.fillRect(trail[i].x * gridSize, trail[i].y * gridSize, gridSize-2, gridSize-2);
            
            // Self Collision
            if(trail[i].x === px && trail[i].y === py) {
                if(tail > 5) gameOver(); // Muori solo se sei "lungo"
            }
        }

        trail.push({x: px, y: py});
        while(trail.length > tail) trail.shift();

        // Apple
        if(ax === px && ay === py) {
            tail++;
            score++;
            scoreEl.innerText = score;
            spawnApple();
        }
        ctx.fillRect(ax*gridSize, ay*gridSize, gridSize-2, gridSize-2);
    }

    function spawnApple() {
        ax = Math.floor(Math.random() * tileCountX);
        ay = Math.floor(Math.random() * tileCountY);
    }

    function gameOver() {
        isPaused = true;
        saveScore(score);
        document.querySelector("#main-menu h1").innerText = "GAME OVER";
        btnResume.style.display = "none"; // Non puoi fare resume se morto
        mainMenu.classList.remove("hidden");
    }

    // --- MOVEMENT ENGINE (INSTANT SWIPE) ---
    function handleTouchStart(e) {
        // Salva punto iniziale
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }

    function handleTouchMove(e) {
        if(isPaused) return;
        e.preventDefault(); // Blocca lo scroll della pagina

        if (!touchStartX || !touchStartY) return;

        let touchEndX = e.touches[0].clientX;
        let touchEndY = e.touches[0].clientY;

        let dx = touchEndX - touchStartX;
        let dy = touchEndY - touchStartY;

        // SOGLIA DI SENSIBILITÀ (15 pixel)
        // Se ti sei mosso di almeno 15px, cambia direzione
        if (Math.abs(dx) > 15 || Math.abs(dy) > 15) {
            
            if (Math.abs(dx) > Math.abs(dy)) {
                // Orizzontale
                input(dx > 0 ? 1 : -1, 0);
            } else {
                // Verticale
                input(0, dy > 0 ? 1 : -1);
            }
            
            // RESET CONTINUO
            // Questo è il trucco: resetto il punto di partenza alle nuove coordinate.
            // Così se continui a girare il dito, il serpente continua a seguire
            // senza dover alzare il dito.
            touchStartX = touchEndX;
            touchStartY = touchEndY;
        }
    }

    function input(x, y) {
        // Anti-inversione
        if (x === -xv && x !== 0) return;
        if (y === -yv && y !== 0) return;
        xv = x;
        yv = y;
    }

    function handleKey(e) {
        switch(e.keyCode) {
            case 37: input(-1, 0); break;
            case 38: input(0, -1); break;
            case 39: input(1, 0); break;
            case 40: input(0, 1); break;
            case 80: openMenu(); break; // P
        }
    }

    // --- MENU SYSTEM ---
    function openMenu() {
        isPaused = true;
        document.querySelector("#main-menu h1").innerText = "PAUSED";
        btnResume.style.display = "block"; // Riabilita resume
        mainMenu.classList.remove("hidden");
    }

    function closeAllMenus() {
        mainMenu.classList.add("hidden");
        lbMenu.classList.add("hidden");
        aboutMenu.classList.add("hidden");
    }

    function backToMain() {
        closeAllMenus();
        mainMenu.classList.remove("hidden");
    }

    function showLeaderboard() {
        closeAllMenus();
        renderLeaderboard();
        lbMenu.classList.remove("hidden");
    }

    function showAbout() {
        closeAllMenus();
        aboutMenu.classList.remove("hidden");
    }

    // --- LEADERBOARD & DATA ---
    const LB_KEY = 'snake_ultra_lb';

    function initLeaderboard() {
        if(!localStorage.getItem(LB_KEY)) {
            const defaults = [
                { n: 'AAAAAAAAA', s: 99999 }, // Easter Egg
                { n: 'SNAKE_KING', s: 250 },
                { n: 'LUCY_RETRO', s: 150 },
                { n: 'MARIO_8BIT', s: 100 },
                { n: 'NOKIA_FAN', s: 50 }
            ];
            localStorage.setItem(LB_KEY, JSON.stringify(defaults));
        }
    }

    function saveScore(newScore) {
        let data = JSON.parse(localStorage.getItem(LB_KEY));
        // Se il punteggio entra in classifica
        if(newScore > data[data.length-1].s) {
            let name = prompt("NEW RECORD! Name:", "PLAYER");
            if(!name) name = "UNKNOWN";
            name = name.substring(0, 10).toUpperCase();
            
            data.push({n: name, s: newScore});
            data.sort((a,b) => b.s - a.s);
            data = data.slice(0, 5); // Keep top 5
            localStorage.setItem(LB_KEY, JSON.stringify(data));
        }
    }

    function renderLeaderboard() {
        let data = JSON.parse(localStorage.getItem(LB_KEY));
        let container = document.getElementById("lb-container");
        container.innerHTML = "";
        
        data.forEach((item, i) => {
            let row = document.createElement("div");
            // Applica stile speciale al primo (Easter egg)
            row.className = (i === 0 && item.s === 99999) ? "lb-row lb-top" : "lb-row";
            row.innerHTML = `<span>${i+1}. ${item.n}</span><span>${item.s}</span>`;
            container.appendChild(row);
        });
    }

</script>
</body>
</html>
