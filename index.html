<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#151515">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>Snake 3310 Ultimate</title>
    <style>
        /* --- STILE ORIGINALE V1 (Quello che funzionava) --- */
        body {
            background: #151515;
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        #orientation-lock {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; color: #fff; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; font-size: 24px; font-weight: bold;
        }
        @media screen and (orientation: landscape) { #orientation-lock { display: flex; } }

        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; z-index: 100; pointer-events: none;
        }
        #score-box { color: #c7f0d8; font-weight: bold; font-size: 24px; text-shadow: 2px 2px 0 #000; }
        
        #pause-btn {
            pointer-events: auto; background: #879c85; color: #000; border: 3px solid #000;
            padding: 8px 16px; font-weight: bold; border-radius: 10px; font-size: 16px;
            cursor: pointer; text-transform: uppercase;
        }

        /* IL CONTENITORE V1 ESATTO */
        #phone-mask {
            position: relative;
            width: 98vw; 
            max-width: 460px; 
            aspect-ratio: 9 / 18; 
            
            border-radius: 55px; 
            overflow: hidden; 
            box-shadow: 0 10px 60px rgba(0,0,0,0.9);
        }

        /* L'IMMAGINE DI SFONDO V1 ESATTA */
        #phone-bg {
            width: 100%;
            height: 100%;
            background-image: url('nokia_frame.JPG'); 
            background-position: center;
            background-repeat: no-repeat;
            background-size: 128%; 
        }

        
        }
        #screen-container {
            position: absolute; top: 23.5%; left: 13.5%; width: 74%; height: 32%;
            background-color: transparent; border-radius: 10px 10px 50px 50px;
            overflow: hidden; z-index: 10;
        }

        canvas {
            display: block; width: 100%; height: 100%;
            image-rendering: pixelated; 
            mix-blend-mode: multiply; 
            opacity: 0.85;
        }

        #touch-surface { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #879c85; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 40px; margin-bottom: 30px; border-bottom: 4px solid #879c85; text-transform: uppercase; letter-spacing: 2px;}
        
        .menu-btn {
            width: 260px; padding: 20px; margin: 10px; background: #000;
            border: 4px solid #879c85; color: #879c85; font-weight: bold; font-size: 22px;
            font-family: inherit; cursor: pointer; transition: transform 0.1s;
        }
        .menu-btn:active { background: #879c85; color: #000; transform: scale(0.95); }
        .gold { color: #ffd700; text-shadow: 0 0 10px orange; }
        .lb-row { width: 300px; display: flex; justify-content: space-between; border-bottom: 1px dashed #555; padding: 12px 0; font-size: 20px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="orientation-lock"><p>⚠️<br>RUOTA IL TELEFONO<br>IN VERTICALE</p></div>

    <div id="top-bar">
        <div id="score-box">SCORE: <span id="score">0</span></div>
        <button id="pause-btn">MENU</button>
    </div>

    <div id="phone-mask">
        <div id="phone-bg">
            <div id="screen-container">
                <canvas id="gc"></canvas>
            </div>
        </div>
    </div>

    <div id="touch-surface"></div>

    <div id="menu-main" class="overlay hidden">
        <h1 id="menu-title">SNAKE 3310</h1>
        <button class="menu-btn" id="btn-resume" style="display:none;">RESUME</button>
        <button class="menu-btn" id="btn-new">NEW GAME</button>
        <button class="menu-btn" id="btn-best">BEST SCORE</button>
        <button class="menu-btn" id="btn-about">ABOUT</button>
    </div>

    <div id="menu-lb" class="overlay hidden">
        <h1>TOP 5</h1>
        <div id="lb-list"></div>
        <button class="menu-btn" id="btn-back-lb">BACK</button>
    </div>

    <div id="menu-about" class="overlay hidden">
        <h1>ABOUT</h1>
        <div style="text-align:center; line-height:1.6; font-size:20px;">
            SNAKE 3310<br>ULTIMATE EDITION<br><br>
            <a href="https://github.com/Dad-89" style="font-size:70px; color:#ff4444; text-decoration:none; display:block; animation: pulse 1s infinite;">&hearts;</a>
        </div>
        <button class="menu-btn" id="btn-back-ab">BACK</button>
    </div>

<script>
    // --- MOTORE JAVASCRIPT DELLA V2 (AUDIO, PWA, LOGICA) ---
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    let audioCtx = null;

    function unlockAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => console.log("Audio unlocked"));
        }
        document.body.removeEventListener('touchstart', unlockAudio);
        document.body.removeEventListener('click', unlockAudio);
    }

    document.body.addEventListener('touchstart', unlockAudio, {passive: false});
    document.body.addEventListener('click', unlockAudio);

    function playSound(type) {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'eat') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'die') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    const canvas = document.getElementById("gc");
    const ctx = canvas.getContext("2d");
    const screenCont = document.getElementById("screen-container");
    
    const GRID = 10; 
    let baseFPS = 15; 
    let currentFPS = baseFPS;
    
    let tX, tY, px, py, trail=[], tail=5, score=0;
    let xv=0, yv=0, nextX=1, nextY=0, hasMoved=false;
    let ax, ay, isPaused=false, isRunning=false, loopId;

    function init() {
        resize(); window.addEventListener('resize', resize);
        const surf = document.getElementById("touch-surface");
        surf.addEventListener('touchstart', handleStart, {passive:false});
        surf.addEventListener('touchmove', handleMove, {passive:false});
        document.addEventListener('keydown', handleKey);
        
        document.getElementById("pause-btn").onclick = openMenuPause;
        document.getElementById("btn-resume").onclick = resumeGame;
        
        document.getElementById("btn-new").onclick = () => {
            unlockAudio();
            startNew();
        };

        document.getElementById("btn-best").onclick = showLb;
        document.getElementById("btn-about").onclick = showAb;
        document.getElementById("btn-back-lb").onclick = openMain;
        document.getElementById("btn-back-ab").onclick = openMain;

        initLb();
        ctx.fillStyle="#879c85"; ctx.fillRect(0,0,canvas.width,canvas.height);
        openMain();
    }

    function resize() {
        canvas.width = screenCont.clientWidth; canvas.height = screenCont.clientHeight;
        tX = Math.floor(canvas.width / GRID); tY = Math.floor(canvas.height / GRID);
    }

    function startNew() {
        closeMenus();
        score=0; document.getElementById("score").innerText="0";
        tail=5; trail=[]; resize();
        px = Math.floor(tX/2); py = Math.floor(tY/2);
        xv=1; yv=0; nextX=1; nextY=0; 
        currentFPS = baseFPS; 
        spawnApple();
        isRunning=true; isPaused=false;
        if(loopId) clearInterval(loopId); 
        loopId = setInterval(update, 1000/currentFPS);
    }

    function update() {
        if(isPaused || !isRunning) return;
        xv=nextX; yv=nextY; hasMoved=false;
        px+=xv; py+=yv;
        if(px<0) px=tX-1; if(px>tX-1) px=0; if(py<0) py=tY-1; if(py>tY-1) py=0;

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#879c85"; ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.fillStyle="#1a2e1a";
        for(let i=0; i<trail.length; i++) {
            ctx.fillRect(trail[i].x*GRID, trail[i].y*GRID, GRID-0.5, GRID-0.5);
            if(trail[i].x===px && trail[i].y===py && tail>5) gameOver();
        }
        trail.push({x:px, y:py}); while(trail.length>tail) trail.shift();

        if(ax===px && ay===py) {
            tail++; score++; 
            document.getElementById("score").innerText=score;
            if(navigator.vibrate) navigator.vibrate(20);
            playSound('eat'); 
            if(score % 5 === 0) {
                currentFPS++;
                clearInterval(loopId);
                loopId = setInterval(update, 1000/currentFPS);
            }
            spawnApple();
        }
        ctx.fillStyle="#000"; ctx.fillRect(ax*GRID, ay*GRID, GRID, GRID);
    }

    function spawnApple() {
        let valid=false;
        while(!valid) {
            ax=Math.floor(Math.random()*tX); ay=Math.floor(Math.random()*tY);
            valid=true; for(let t of trail) if(t.x===ax && t.y===ay) valid=false;
        }
    }

    function gameOver() {
        if(navigator.vibrate) navigator.vibrate(400);
        playSound('die'); 
        isRunning=false; saveScore(score);
        document.getElementById("menu-title").innerText = "GAME OVER";
        document.getElementById("btn-resume").style.display = "none";
        document.getElementById("menu-main").classList.remove("hidden");
    }

    let tStartX;
    function handleStart(e) { e.preventDefault(); tStartX=e.touches[0].clientX; tStartY=e.touches[0].clientY; }
    function handleMove(e) {
        if(isPaused || !isRunning) return; e.preventDefault();
        if(!tStartX) return;
        let dx=e.touches[0].clientX-tStartX, dy=e.touches[0].clientY-tStartY;
        if(Math.abs(dx)>10 || Math.abs(dy)>10) {
            if(hasMoved) return;
            if(Math.abs(dx)>Math.abs(dy)) change(dx>0?1:-1, 0); else change(0, dy>0?1:-1);
            tStartX=e.touches[0].clientX; tStartY=e.touches[0].clientY;
        }
    }
    function handleKey(e) {
        switch(e.key) {
            case 'ArrowLeft': change(-1,0); break; case 'ArrowUp': change(0,-1); break;
            case 'ArrowRight': change(1,0); break; case 'ArrowDown': change(0,1); break;
            case 'p': openMenuPause(); break;
        }
    }
    function change(x,y) {
        if(x===-xv && x!==0) return; if(y===-yv && y!==0) return;
        nextX=x; nextY=y; hasMoved=true;
    }

    function openMenuPause() {
        if(!isRunning && document.getElementById("menu-title").innerText==="GAME OVER") {
             document.getElementById("menu-main").classList.remove("hidden"); return;
        }
        isPaused = true;
        document.getElementById("menu-title").innerText="PAUSED";
        document.getElementById("btn-resume").style.display="block";
        openMain();
    }
    function resumeGame() { closeMenus(); isPaused = false; }
    function closeMenus() { document.querySelectorAll('.overlay').forEach(e=>e.classList.add('hidden')); }
    function openMain() { closeMenus(); document.getElementById("menu-main").classList.remove("hidden"); }
    function showLb() { closeMenus(); renderLb(); document.getElementById("menu-lb").classList.remove("hidden"); }
    function showAb() { closeMenus(); document.getElementById("menu-about").classList.remove("hidden"); }

    const LB_KEY='snake_legend_lb';
    function initLb() {
        if(!localStorage.getItem(LB_KEY)) localStorage.setItem(LB_KEY, JSON.stringify([
            {n:'AAAAAAAAA',s:999999}, {n:'HACKER',s:500}, {n:'RETRO',s:200}, {n:'NOKIA',s:50}, {n:'USER',s:10}
        ]));
    }
    function saveScore(s) {
        let d = JSON.parse(localStorage.getItem(LB_KEY));
        if(s>d[d.length-1].s) {
            let n=prompt("RECORD! Inserisci Nome:","PLAYER"); if(!n) n="UNKNOWN";
            d.push({n:n.substring(0,10).toUpperCase(),s:s}); d.sort((a,b)=>b.s-a.s);
            localStorage.setItem(LB_KEY, JSON.stringify(d.slice(0,5)));
        }
    }
    function renderLb() {
        let d=JSON.parse(localStorage.getItem(LB_KEY));
        let l=document.getElementById("lb-list"); l.innerHTML="";
        d.forEach((x,i)=>{
            let r=document.createElement("div"); r.className="lb-row";
            if(i===0 && x.s===999999) r.classList.add("gold");
            r.innerHTML=`<span>${i+1}.${x.n}</span><span>${x.s}</span>`;
            l.appendChild(r);
        });
    }

    window.onload=init;
</script>
</body>
</html>
