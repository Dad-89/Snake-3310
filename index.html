<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Snake 3310 Legend</title>
    <style>
        /* --- LAYOUT GENERALE --- */
        body {
            background: #151515; /* Nero profondo per contrasto */
            margin: 0;
            overflow: hidden; /* Niente scroll */
            position: fixed; /* Fix per rimbalzo iOS */
            width: 100%;
            height: 100%;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none; /* Disabilita zoom e pan */
        }

        /* --- AVVISO ROTAZIONE --- */
        #orientation-lock {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            color: #fff; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; font-size: 24px; font-weight: bold;
        }
        @media screen and (orientation: landscape) {
            #orientation-lock { display: flex; }
        }

        /* --- BARRA SUPERIORE --- */
        #top-bar {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box;
            z-index: 100; pointer-events: none;
        }
        #score-box { 
            color: #c7f0d8; font-weight: bold; font-size: 24px; 
            text-shadow: 2px 2px 0 #000;
        }
        #pause-btn {
            pointer-events: auto;
            background: #879c85; color: #000; border: 3px solid #000;
            padding: 8px 16px; font-weight: bold; border-radius: 10px;
            font-size: 16px; cursor: pointer; text-transform: uppercase;
        }

        /* --- CONTENITORE TELEFONO (FUSTELLA) --- */
        #phone-mask {
            position: relative;
            width: 98vw; 
            max-width: 460px; 
            aspect-ratio: 9 / 18; 
            
            border-radius: 55px; 
            overflow: hidden; 
            box-shadow: 0 10px 60px rgba(0,0,0,0.9);
        }

        /* --- IMMAGINE SFONDO --- */
        #phone-bg {
            width: 100%;
            height: 100%;
            background-image: url('nokia_frame.JPG'); /* Controlla il nome file! */
            background-position: center;
            background-repeat: no-repeat;
            background-size: 128%; /* Zoom per tagliare i bordi scacchi */
        }

        /* --- SCHERMO DI GIOCO (CALIBRAZIONE DEFINITIVA) --- */
  #screen-container {
    position: absolute;
    /* Sposta l'inizio dello schermo più in basso, sotto la scritta NOKIA */
    top: 28%;
    /* Allunga lo schermo verso il basso, fino a prima dei tasti */
    height: 34%;
    /* Mantiene la posizione orizzontale */
    left: 13%;
    /* Mantiene la larghezza */
    width: 73%;
    /* Rende lo sfondo trasparente */
    background-color: transparent;
    /* Rimuove l'ombra */
    box-shadow: none;
    /* Arrotonda leggermente gli angoli per seguire la forma dello schermo */
    border-radius: 15px;
    /* Assicura che il serpente non esca dai bordi del contenitore */
    overflow: hidden;
    z-index: 10;
}

        canvas {
            display: block; width: 100%; height: 100%;
            image-rendering: pixelated;
            /* QUESTA È LA CHIAVE PER IL REALISMO */
            /* Fonde i pixel neri con le ombre verdi dell'immagine sotto */
            mix-blend-mode: multiply; 
            opacity: 0.85; 
        }

        /* --- INPUT LAYER --- */
        #touch-surface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50;
        }

        /* --- STILE MENU --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #879c85;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 40px; margin-bottom: 30px; border-bottom: 4px solid #879c85; text-transform: uppercase;}
        
        .menu-btn {
            width: 260px; padding: 20px; margin: 10px;
            background: #000; border: 4px solid #879c85;
            color: #879c85; font-weight: bold; font-size: 22px;
            font-family: inherit; cursor: pointer;
        }
        .menu-btn:active { background: #879c85; color: #000; }
        
        .gold { color: #ffd700; text-shadow: 0 0 10px orange; }
        .lb-row { width: 300px; display: flex; justify-content: space-between; border-bottom: 1px dashed #555; padding: 12px 0; font-size: 20px; }

    </style>
</head>
<body>

    <div id="orientation-lock">
        <p>⚠️<br>RUOTA IL TELEFONO<br>IN VERTICALE</p>
    </div>

    <div id="top-bar">
        <div id="score-box">SCORE: <span id="score">0</span></div>
        <button id="pause-btn">MENU</button>
    </div>

    <div id="phone-mask">
        <div id="phone-bg">
            <div id="screen-container">
                <canvas id="gc"></canvas>
            </div>
        </div>
    </div>

    <div id="touch-surface"></div>

    <div id="menu-main" class="overlay hidden">
        <h1 id="menu-title">SNAKE 3310</h1>
        <button class="menu-btn" id="btn-resume" style="display:none;">RESUME</button>
        <button class="menu-btn" id="btn-new">NEW GAME</button>
        <button class="menu-btn" id="btn-best">BEST SCORE</button>
        <button class="menu-btn" id="btn-about">ABOUT</button>
    </div>

    <div id="menu-lb" class="overlay hidden">
        <h1>TOP 5</h1>
        <div id="lb-list"></div>
        <button class="menu-btn" id="btn-back-lb">BACK</button>
    </div>

    <div id="menu-about" class="overlay hidden">
        <h1>ABOUT</h1>
        <div style="text-align:center; line-height:1.6; font-size:20px;">
            SNAKE 3310<br>LEGEND EDITION<br><br>
            <a href="https://github.com/Dad-89" style="font-size:70px; color:#ff4444; text-decoration:none; display:block; animation: pulse 1s infinite;">&hearts;</a>
        </div>
        <button class="menu-btn" id="btn-back-ab">BACK</button>
    </div>

    <style>@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }</style>

<script>
    // ==========================================
    // CONFIGURAZIONE VARIABILI
    // ==========================================
    const canvas = document.getElementById("gc"); 
    const ctx = canvas.getContext("2d"); 
    const screenCont = document.getElementById("screen-container"); 
    
    const GRID = 10; // Dimensione pixel (quanto è grosso il serpente)
    const FPS = 15;  // Velocità (Frame al secondo)
    
    // Variabili di stato (cambiano durante il gioco)
    let tX, tY;     // Numero di celle (Colonne, Righe)
    let px, py;     // Posizione Giocatore (Player X, Y)
    let trail = []; // Coda del serpente
    let tail = 5;   // Lunghezza serpente
    let score = 0;  // Punteggio attuale
    
    let xv = 0, yv = 0;       // Velocità attuale
    let nextX = 1, nextY = 0; // Prossima mossa (Buffer input)
    let hasMoved = false;     // Controllo anti-doppio input
    
    let ax, ay;               // Posizione Mela (Apple)
    let isPaused = false;     // Stato Pausa
    let isRunning = false;    // Stato Partita in corso
    let loopId;               // Timer del gioco

    // ==========================================
    // INIZIALIZZAZIONE (BOOT)
    // ==========================================
    function init() {
        resize(); // Calcola dimensioni schermo
        window.addEventListener('resize', resize); // Ricalcola se ruoti
        
        // Attiva Input Touch
        const surf = document.getElementById("touch-surface");
        surf.addEventListener('touchstart', handleStart, {passive:false});
        surf.addEventListener('touchmove', handleMove, {passive:false});
        
        // Attiva Input Tastiera
        document.addEventListener('keydown', handleKey);
        
        // Collega i bottoni del menu
        document.getElementById("pause-btn").onclick = openMenuPause;
        document.getElementById("btn-resume").onclick = resumeGame;
        document.getElementById("btn-new").onclick = startNew;
        document.getElementById("btn-best").onclick = showLb;
        document.getElementById("btn-about").onclick = showAb;
        document.getElementById("btn-back-lb").onclick = openMain;
        document.getElementById("btn-back-ab").onclick = openMain;

        initLb(); // Prepara classifica
        
        // Apre il menu iniziale (NON avvia il gioco subito)
        openMain(); 
    }

    // Adatta la griglia di gioco al contenitore CSS
    function resize() {
        canvas.width = screenCont.clientWidth;
        canvas.height = screenCont.clientHeight;
        tX = Math.floor(canvas.width / GRID); 
        tY = Math.floor(canvas.height / GRID);
    }

    // ==========================================
    // LOGICA DI GIOCO (GAME LOOP)
    // ==========================================
    
    // Avvia una nuova partita da zero
    function startNew() {
        closeMenus(); // Chiudi le finestre
        score = 0; 
        document.getElementById("score").innerText = "0";
        tail = 5; 
        trail = []; 
        resize();
        
        // Metti il serpente al centro
        px = Math.floor(tX / 2); 
        py = Math.floor(tY / 2);
        
        // Direzione iniziale: destra
        xv = 1; yv = 0; 
        nextX = 1; nextY = 0;
        
        spawnApple(); // Crea la prima mela
        isRunning = true; 
        isPaused = false;
        
        // Avvia il ciclo
        if(loopId) clearInterval(loopId); 
        loopId = setInterval(update, 1000/FPS);
    }

    // Funzione eseguita 15 volte al secondo
    function update() {
        if(isPaused || !isRunning) return; // Se fermo, esci
        
        // Applica direzione
        xv = nextX; yv = nextY; 
        hasMoved = false; 
        
        // Aggiorna posizione testa
        px += xv; py += yv;
        
        // Effetto Wrap (Passa attraverso i muri)
        if(px < 0) px = tX - 1; 
        if(px > tX - 1) px = 0; 
        if(py < 0) py = tY - 1; 
        if(py > tY - 1) py = 0;

        // Pulisci il canvas (Trasparente per far vedere lo sfondo)
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Disegna Serpente
        ctx.fillStyle = "#1a2e1a"; // Colore LCD scuro
        for(let i=0; i<trail.length; i++) {
            // Disegna quadrato con gap minimo
            ctx.fillRect(trail[i].x*GRID, trail[i].y*GRID, GRID-0.5, GRID-0.5);
            
            // Se la testa tocca il corpo -> Game Over
            if(trail[i].x === px && trail[i].y === py && tail > 5) gameOver();
        }
        
        // Aggiorna coda
        trail.push({x:px, y:py}); 
        while(trail.length > tail) trail.shift(); 

        // Se mangia la mela
        if(ax === px && ay === py) {
            tail++; 
            score++; 
            document.getElementById("score").innerText = score;
            if(navigator.vibrate) navigator.vibrate(20); // Feedback tattile
            spawnApple();
        }
        
        // Disegna Mela
        ctx.fillStyle = "#000"; 
        ctx.fillRect(ax*GRID, ay*GRID, GRID, GRID);
    }

    // Genera mela in posizione casuale (non sopra il serpente)
    function spawnApple() {
        let valid = false;
        while(!valid) {
            ax = Math.floor(Math.random() * tX); 
            ay = Math.floor(Math.random() * tY);
            valid = true; 
            for(let t of trail) if(t.x === ax && t.y === ay) valid = false;
        }
    }

    function gameOver() {
        if(navigator.vibrate) navigator.vibrate(400); // Bzzz lungo
        isRunning = false; 
        saveScore(score); 
        
        // Mostra schermata Game Over
        document.getElementById("menu-title").innerText = "GAME OVER";
        document.getElementById("btn-resume").style.display = "none"; 
        document.getElementById("menu-main").classList.remove("hidden"); 
    }

    // ==========================================
    // GESTIONE INPUT (Touch & Tasti)
    // ==========================================
    let tStartX;
    
    function handleStart(e) { 
        e.preventDefault(); 
        tStartX = e.touches[0].clientX; 
        tStartY = e.touches[0].clientY; 
    }
    
    function handleMove(e) {
        if(isPaused || !isRunning) return; 
        e.preventDefault();
        if(!tStartX) return;
        
        let dx = e.touches[0].clientX - tStartX;
        let dy = e.touches[0].clientY - tStartY;
        
        // Rileva swipe > 10px
        if(Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            if(hasMoved) return; // Aspetta prossimo frame
            
            if(Math.abs(dx) > Math.abs(dy)) change(dx > 0 ? 1 : -1, 0); 
            else change(0, dy > 0 ? 1 : -1);
            
            // Reset per swipe continuo
            tStartX = e.touches[0].clientX; 
            tStartY = e.touches[0].clientY;
        }
    }
    
    function handleKey(e) {
        switch(e.key) {
            case 'ArrowLeft': change(-1,0); break; 
            case 'ArrowUp': change(0,-1); break;
            case 'ArrowRight': change(1,0); break; 
            case 'ArrowDown': change(0,1); break;
            case 'p': openMenuPause(); break;
        }
    }
    
    // Cambia direzione (con protezione inversione a U)
    function change(x,y) {
        if(x === -xv && x !== 0) return; 
        if(y === -yv && y !== 0) return;
        nextX = x; nextY = y; 
        hasMoved = true;
    }

    // ==========================================
    // SISTEMA MENU
    // ==========================================
    function openMenuPause() {
        if(!isRunning && document.getElementById("menu-title").innerText === "GAME OVER") {
             document.getElementById("menu-main").classList.remove("hidden");
             return;
        }
        isPaused = true;
        document.getElementById("menu-title").innerText = "PAUSED";
        document.getElementById("btn-resume").style.display = "block"; 
        openMain();
    }
    
    function resumeGame() { closeMenus(); isPaused = false; }
    
    function closeMenus() { document.querySelectorAll('.overlay').forEach(e => e.classList.add('hidden')); }
    function openMain() { closeMenus(); document.getElementById("menu-main").classList.remove("hidden"); }
    function showLb() { closeMenus(); renderLb(); document.getElementById("menu-lb").classList.remove("hidden"); }
    function showAb() { closeMenus(); document.getElementById("menu-about").classList.remove("hidden"); }

    // ==========================================
    // PERSISTENZA DATI (LocalStorage)
    // ==========================================
    const LB_KEY = 'snake_legend_lb';
    
    function initLb() {
        if(!localStorage.getItem(LB_KEY)) localStorage.setItem(LB_KEY, JSON.stringify([
            {n:'AAAAAAAAA',s:999999}, 
            {n:'HACKER',s:500}, 
            {n:'RETRO',s:200}, 
            {n:'NOKIA',s:50}, 
            {n:'USER',s:10}
        ]));
    }
    
    function saveScore(s) {
        let d = JSON.parse(localStorage.getItem(LB_KEY));
        if(s > d[d.length-1].s) {
            let n = prompt("RECORD! Inserisci Nome:","PLAYER"); 
            if(!n) n = "UNKNOWN";
            d.push({n:n.substring(0,10).toUpperCase(),s:s}); 
            d.sort((a,b)=>b.s-a.s);
            localStorage.setItem(LB_KEY, JSON.stringify(d.slice(0,5)));
        }
    }
    
    function renderLb() {
        let d = JSON.parse(localStorage.getItem(LB_KEY));
        let l = document.getElementById("lb-list"); 
        l.innerHTML = "";
        d.forEach((x,i) => {
            let r = document.createElement("div"); 
            r.className = "lb-row";
            if(i === 0 && x.s === 999999) r.classList.add("gold"); 
            r.innerHTML = `<span>${i+1}.${x.n}</span><span>${x.s}</span>`;
            l.appendChild(r);
        });
    }

    // START
    window.onload = init;
</script>
</body>
</html>
