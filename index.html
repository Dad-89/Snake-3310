<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Snake 3310 Perfect</title>
    <style>
        /* --- CORE LAYOUT --- */
        body {
            background-color: #222;
            margin: 0;
            overflow: hidden; /* Stop scroll */
            position: fixed; /* Stop elastic bounce on iOS */
            width: 100%;
            height: 100%;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }

        /* --- TOP BAR --- */
        #top-bar {
            height: 50px;
            background: #000;
            color: #879c85;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 2px solid #555;
            z-index: 100;
            flex-shrink: 0;
        }
        #score-box { font-weight: bold; font-size: 18px; }
        #pause-btn {
            background: #879c85; color: #000; border: none;
            padding: 5px 15px; font-weight: bold; border-radius: 4px;
            font-size: 14px;
        }

        /* --- STAGE DI GIOCO --- */
        #stage {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #333;
            width: 100%;
        }

        /* --- TELAIO NOKIA --- */
        #phone {
            position: relative;
            aspect-ratio: 9 / 17; /* Ratio approssimativo telefono */
            height: 96%; /* Occupa quasi tutta l'altezza */
            width: auto;
            background-image: url('nokia_frame.JPG'); /* <--- FILE IMMAGINE */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* --- SCHERMO LCD (ANCORA) --- */
        #screen {
            position: absolute;
            /* CALIBRAZIONE: Modifica questi valori se lo schermo non è allineato */
            top: 26%;
            left: 23%;
            width: 54%;
            height: 23%;
            
            background-color: #879c85;
            border-radius: 3px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Classe per il bordo rosso di calibrazione (si toglie da sola) */
        .debug-border { border: 2px solid red; box-sizing: border-box; }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            opacity: 0.9;
        }

        /* --- TOUCH LAYER INVISIBILE --- */
        #touch-zone {
            position: absolute;
            top: 50px; left: 0; bottom: 0; right: 0;
            z-index: 50;
        }

        /* --- MENUS --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 200;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #879c85;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 32px; letter-spacing: 4px; margin-bottom: 30px; }
        
        .btn {
            width: 200px; padding: 15px; margin: 10px;
            background: transparent; border: 2px solid #879c85;
            color: #879c85; font-weight: bold; font-size: 18px;
            font-family: inherit;
        }
        .btn:active { background: #879c85; color: #000; }

        /* Easter Egg Style */
        .gold-score { color: #ffeb3b; text-shadow: 0 0 5px orange; }
        .lb-row { width: 250px; display: flex; justify-content: space-between; border-bottom: 1px dashed #444; margin-bottom: 8px; font-size: 16px; }

    </style>
</head>
<body>

    <div id="top-bar">
        <div id="score-box">SCORE: <span id="score">0</span></div>
        <button id="pause-btn">PAUSE</button>
    </div>

    <div id="stage">
        <div id="phone">
            <div id="screen" class="debug-border">
                <canvas id="gc"></canvas>
            </div>
        </div>
    </div>

    <div id="touch-zone"></div>

    <div id="menu-main" class="overlay hidden">
        <h1 id="menu-title">PAUSED</h1>
        <button class="btn" id="btn-resume">RESUME</button>
        <button class="btn" id="btn-new">NEW GAME</button>
        <button class="btn" id="btn-best">BEST SCORE</button>
        <button class="btn" id="btn-about">ABOUT</button>
    </div>

    <div id="menu-lb" class="overlay hidden">
        <h1>TOP 5</h1>
        <div id="lb-list"></div>
        <button class="btn" id="btn-back-lb">BACK</button>
    </div>

    <div id="menu-about" class="overlay hidden">
        <h1>ABOUT</h1>
        <div style="text-align:center; line-height:1.5; font-size:18px;">
            I LOVE<br>NOKIA 3310<br><br>
            <a href="https://github.com/Dad-89" style="font-size:50px; color:red; text-decoration:none;">&hearts;</a>
        </div>
        <button class="btn" id="btn-back-ab">BACK</button>
    </div>

<script>
    // --- ENGINE VARIABLES ---
    const canvas = document.getElementById("gc");
    const ctx = canvas.getContext("2d");
    const screenDiv = document.getElementById("screen");
    
    // Configurazione
    const GRID_SIZE = 10; // Pixel size
    const FPS = 15;       // Speed
    
    let tileX, tileY; // Dimensioni griglia (calcolate dinamicamente)
    
    // Stato Gioco
    let px, py;       // Posizione Snake
    let trail = [];   // Corpo Snake
    let tail = 5;     // Lunghezza
    let score = 0;
    
    // Velocity & Input Buffer (FIX BUG 1)
    let xv = 0, yv = 0;       // Velocità corrente
    let nextX = 1, nextY = 0; // Velocità bufferizzata (prossimo frame)
    let hasMoved = false;     // Flag: ci siamo mossi in questo frame?
    
    let ax, ay;       // Mela
    
    let isPaused = false;
    let isRunning = false;
    let gameLoopId;

    // --- SETUP & RESIZE ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // Touch Handlers (FIX BUG 3)
        const touchZone = document.getElementById("touch-zone");
        touchZone.addEventListener('touchstart', handleTouchStart, {passive: false});
        touchZone.addEventListener('touchmove', handleTouchMove, {passive: false});
        
        // Keyboard Handlers
        document.addEventListener('keydown', handleKey);
        
        // Buttons
        document.getElementById("pause-btn").onclick = togglePause;
        document.getElementById("btn-resume").onclick = togglePause;
        document.getElementById("btn-new").onclick = startNewGame;
        document.getElementById("btn-best").onclick = showLeaderboard;
        document.getElementById("btn-about").onclick = showAbout;
        document.getElementById("btn-back-lb").onclick = openMainMenu;
        document.getElementById("btn-back-ab").onclick = openMainMenu;

        initLeaderboard();
        startNewGame();
    }

    function resize() {
        // Allinea canvas al div "screen"
        canvas.width = screenDiv.clientWidth;
        canvas.height = screenDiv.clientHeight;
        
        tileX = Math.floor(canvas.width / GRID_SIZE);
        tileY = Math.floor(canvas.height / GRID_SIZE);
    }

    // --- GAME LOOP ---
    function startNewGame() {
        closeMenus();
        // Rimuovi bordo rosso di debug dopo il primo avvio
        screenDiv.classList.remove("debug-border");
        
        // Reset Stato
        score = 0; document.getElementById("score").innerText = "0";
        tail = 5; trail = [];
        
        // Centro
        resize(); // Sicurezza
        px = Math.floor(tileX / 2);
        py = Math.floor(tileY / 2);
        
        // Start Right
        xv = 1; yv = 0;
        nextX = 1; nextY = 0;
        
        spawnApple();
        
        isRunning = true;
        isPaused = false;
        
        if(gameLoopId) clearInterval(gameLoopId);
        gameLoopId = setInterval(update, 1000/FPS);
    }

    function update() {
        if(isPaused || !isRunning) return;

        // APPLICAZIONE INPUT (Bufferizzato)
        xv = nextX;
        yv = nextY;
        hasMoved = false; // Reset flag per il nuovo frame

        // MOVIMENTO
        px += xv;
        py += yv;

        // WRAP (Muri infiniti)
        if(px < 0) px = tileX - 1;
        if(px > tileX - 1) px = 0;
        if(py < 0) py = tileY - 1;
        if(py > tileY - 1) py = 0;

        // BACKGROUND
        ctx.fillStyle = "#879c85";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // DISEGNA SNAKE
        ctx.fillStyle = "#112211"; // Nokia Blackish
        for(let i=0; i<trail.length; i++) {
            ctx.fillRect(trail[i].x * GRID_SIZE, trail[i].y * GRID_SIZE, GRID_SIZE-1, GRID_SIZE-1);
            
            // COLLISIONE (Self)
            if(trail[i].x === px && trail[i].y === py) {
                // Ignora collisione se stiamo "uscendo" dalla coda (bug visivo raro)
                if(tail > 5) gameOver();
            }
        }

        trail.push({x: px, y: py});
        while(trail.length > tail) trail.shift();

        // MANGIA MELA
        if(ax === px && ay === py) {
            tail++;
            score++;
            document.getElementById("score").innerText = score;
            vibrate(20); // Feedback tattile leggero
            spawnApple();
        }

        // DISEGNA MELA
        ctx.fillStyle = "#000";
        ctx.fillRect(ax*GRID_SIZE, ay*GRID_SIZE, GRID_SIZE, GRID_SIZE);
    }

    // FIX BUG 2: SPAWN INTELLIGENTE
    function spawnApple() {
        let valid = false;
        while(!valid) {
            ax = Math.floor(Math.random() * tileX);
            ay = Math.floor(Math.random() * tileY);
            
            valid = true;
            // Controlla se è sopra il serpente
            for(let t of trail) {
                if(t.x === ax && t.y === ay) {
                    valid = false;
                    break;
                }
            }
        }
    }

    function gameOver() {
        vibrate(200); // Feedback tattile lungo
        isRunning = false;
        saveScore(score);
        document.getElementById("menu-title").innerText = "GAME OVER";
        document.getElementById("btn-resume").style.display = "none";
        document.getElementById("menu-main").classList.remove("hidden");
    }

    // --- INPUT HANDLING (BUFFER SYSTEM) ---
    // Questo sistema impedisce al serpente di girarsi di 180° in un frame
    
    let touchX, touchY;

    function handleTouchStart(e) {
        e.preventDefault();
        touchX = e.touches[0].clientX;
        touchY = e.touches[0].clientY;
    }

    function handleTouchMove(e) {
        if(isPaused || !isRunning) return;
        e.preventDefault();
        
        if(!touchX || !touchY) return;

        let curX = e.touches[0].clientX;
        let curY = e.touches[0].clientY;
        let dx = curX - touchX;
        let dy = curY - touchY;

        // Sensibilità swipe
        if(Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            // Se abbiamo già processato un input in questo frame tick, ignoriamo (evita suicidio)
            if(hasMoved) return; 

            if(Math.abs(dx) > Math.abs(dy)) {
                changeDir(dx > 0 ? 1 : -1, 0);
            } else {
                changeDir(0, dy > 0 ? 1 : -1);
            }
            
            // Reset per continuous tracking
            touchX = curX;
            touchY = curY;
        }
    }

    function handleKey(e) {
        switch(e.key) {
            case 'ArrowLeft': changeDir(-1, 0); break;
            case 'ArrowUp': changeDir(0, -1); break;
            case 'ArrowRight': changeDir(1, 0); break;
            case 'ArrowDown': changeDir(0, 1); break;
            case 'p': togglePause(); break;
        }
    }

    function changeDir(x, y) {
        // NON permettere inversione di 180° rispetto alla velocità CORRENTE (xv, yv)
        if(x === -xv && x !== 0) return;
        if(y === -yv && y !== 0) return;
        
        // Se passa il controllo, imposta la velocità per il PROSSIMO frame
        nextX = x;
        nextY = y;
        hasMoved = true; // Input accettato per questo frame
        vibrate(5); // Micro feedback
    }

    function vibrate(ms) {
        if(navigator.vibrate) navigator.vibrate(ms);
    }

    // --- MENU LOGIC ---
    function togglePause() {
        if(!isRunning && document.getElementById("menu-title").innerText === "GAME OVER") return;
        
        if(isPaused) {
            closeMenus();
            isPaused = false;
        } else {
            isPaused = true;
            document.getElementById("menu-title").innerText = "PAUSED";
            document.getElementById("btn-resume").style.display = "block";
            document.getElementById("menu-main").classList.remove("hidden");
        }
    }

    function closeMenus() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    }
    
    function openMainMenu() {
        closeMenus();
        document.getElementById("menu-main").classList.remove("hidden");
    }

    function showLeaderboard() {
        closeMenus();
        renderLeaderboard();
        document.getElementById("menu-lb").classList.remove("hidden");
    }

    function showAbout() {
        closeMenus();
        document.getElementById("menu-about").classList.remove("hidden");
    }

    // --- STORAGE ---
    const LB_KEY = 'snake_3310_perfect_lb';
    
    function initLeaderboard() {
        if(!localStorage.getItem(LB_KEY)) {
            const defaults = [
                { n: 'AAAAAAAAA', s: 999999 },
                { n: 'HACKER_MAN', s: 500 },
                { n: 'OLD_SCHOOL', s: 250 },
                { n: 'NOKIA_3310', s: 100 },
                { n: 'GUEST', s: 10 }
            ];
            localStorage.setItem(LB_KEY, JSON.stringify(defaults));
        }
    }

    function saveScore(s) {
        let data = JSON.parse(localStorage.getItem(LB_KEY));
        if(s > data[data.length-1].s) {
            let name = prompt("NEW HIGHSCORE! Name:", "PLAYER");
            if(!name) name = "UNKNOWN";
            name = name.substring(0, 10).toUpperCase();
            data.push({n: name, s: s});
            data.sort((a,b) => b.s - a.s);
            data = data.slice(0, 5);
            localStorage.setItem(LB_KEY, JSON.stringify(data));
        }
    }

    function renderLeaderboard() {
        let data = JSON.parse(localStorage.getItem(LB_KEY));
        let list = document.getElementById("lb-list");
        list.innerHTML = "";
        data.forEach((item, i) => {
            let row = document.createElement("div");
            row.className = "lb-row";
            if(i===0 && item.s === 999999) row.classList.add("gold-score");
            row.innerHTML = `<span>${i+1}. ${item.n}</span><span>${item.s}</span>`;
            list.appendChild(row);
        });
    }

    window.onload = init;

</script>
</body>
</html>
